# M5Cardputer キーボードマトリックススキャンプロジェクト

M5Cardputerのキーボードマトリックスをスキャンして、キーの押下を検出するArduinoプロジェクトです。

## 概要

このプロジェクトは、M5Cardputerのキーボードの物理的な構造を理解し、キーマトリックスのスキャン方法を学習することを目的としています。74HC138デコーダーを使用した8行×7列のキーマトリックスをスキャンし、どのキーが押されたかをシリアルモニターに表示します。

## ハードウェア構成

- **行制御**: 74HC138デコーダーによる8行の制御
  - A0 (GPIO 8)
  - A1 (GPIO 9)
  - A2 (GPIO 11)
- **列検出**: 7つの列の直接GPIO接続
  - GPIO 3, 4, 5, 6, 7, 13, 15

## 使用デバイス

- M5Stack STAMP S3

## 機能

- 8×7キーマトリックスの全スキャン
- キー押下の検出とシリアル出力
- チャタリング防止機能
- リアルタイムキー状態監視

## 技術的詳細

### キーマトリックススキャンの仕組み

1. 74HC138デコーダーを使用して8行を順次選択
2. 選択された行をLOWレベルにアクティブ化
3. 7つの列をプルアップ抵抗でHIGHに保持
4. キーが押されると、アクティブな行と列が接続されて列がLOWになる
5. この変化を検出してキー押下を判定

74HC138には3ビットのGPIOが接続されています。これにより、8パターンの選択が可能です。0x00～0x07と考えるとよいでしょう。これが8行に相当します。

### M5CardPuterの実際のキーマトリックス

M5CardPuterは、14列4行のキーボードを持っています。これを、7列8行にマッピングしています。物理配置とGPIO接続上の配置が直感的ではないのですが、下の表のように接続されています。

| 行/列 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 |
|-------|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| 0     | R7C5 | R3C5 | R7C6 | R3C6 | R7C0 | R3C0 | R7C1  | R3C1 | R7C2 | R3C2 | R7C3 | R3C3 | R7C4 | R3C4 |
| 1     | R6C5 | R2C5 | R6C6 | R2C6 | R6C0 | R2C0 | R6C1  | R2C1 | R6C2 | R2C2 | R6C3 | R2C3 | R6C4 | R2C4 |
| 2     | R5C5 | R1C5 | R5C6 | R1C6 | R5C0 | R1C0 | R5C1  | R1C1 | R5C2 | R1C2 | R5C3 | R1C3 | R5C4 | R1C4 |
| 3     | R4C5 | R0C5 | R4C6 | R0C6 | R4C0 | R0C0 | R4C1  | R0C1 | R4C2 | R0C2 | R4C3 | R0C3 | R4C4 | R0C4 |

## 参考資料

- [M5Cardputer公式ドキュメント](https://docs.m5stack.com/en/core/Cardputer)
- [74HC138データシート](https://www.ti.com/lit/ds/symlink/sn74hc138.pdf)

## 追記

このドキュメントは、初期調査とサンプルコードの生成をGemini2.5 Proで行い、READMEの作成をClaude Sonnet 4に手伝ってもらいました。

## 連絡先など

間違い・改善提案などありましたら、プルリクエストをくださるかご連絡くださると嬉しいです。

- KIRIAKE Masanori [seiken@rd01.net](mailto:seiken@rd01.net)
- GitHub [ji6czd](https://github.com/ji6czd)
- Twitter [ji6czd](https://x.com/ji6czd)
